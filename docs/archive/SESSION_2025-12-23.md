# Session 2025-12-23: Comprehensive Schema Audit + Exception Detection Fix

## Issues Fixed This Session

### Issue 1: Row Colors Applied to Action Column (B)
The Action column should stay WHITE but was getting row alternating colors.

**Fixed Files:**
- `logins.py`: `[2,3,4,5,8]` → `[3,4,5,6,9]`
- `roles.py`: `[2,3,4,5,6]` → `[3,4,5,6,7]`
- `services.py`: `[2,3,4,5,8]` → `[3,4,5,6,9]`

### Issue 2: Enabled Column Empty
The Enabled column was writing to wrong cell indices.

**Fixed:**
| File | Column | Old Index | New Index |
|------|--------|-----------|-----------|
| `logins.py` | Enabled | 6 | 7 |
| `logins.py` | Password Policy | 7 | 8 |
| `roles.py` | Enabled | 7 | 8 |
| `services.py` | Status | 6 | 7 |
| `services.py` | Startup | 7 | 8 |
| `services.py` | Compliant | 9 | 10 |

### Issue 3: Exceptions Not Persisting to Actions/Stats
The `detect_exception_changes` function was failing to detect exceptions for sheets without a "Status" column (Sensitive Roles, Services, Client Protocols, etc).

**Root Cause:**
The fallback discrepancy detection only checked `fields.get("status")`, but:
1. Sensitive Roles sheet has "Review Status", not "Status"
2. The `action_needed` field (set from ⏳ in Action column) was being ignored

**Fix in `annotation_sync.py` line 1068:**
```python
# Before (BUG):
# NOTE: Do NOT use action_needed here - that flag being True doesn't mean discrepant

# After (FIXED):
# CRITICAL: For sheets without Status column (Sensitive Roles, Services),
# the ONLY way to detect discrepancy is via action_needed field
if fields.get("action_needed", False):
    is_discrepant = True
```

---

## All Column Index Fixes (17 Files Total)

| File | Primary Fixes |
|------|--------------|
| `logins.py` | Server merge, row colors, Enabled, Policy columns |
| `roles.py` | Server merge, row colors, Enabled, highlight columns |
| `services.py` | Server merge, row colors, Status, Startup, Compliant columns |
| `instances.py` | Server merge 2→3, Instance merge 3→4 |
| `db_users.py` | Login Status 8→9, Compliant 9→10 |
| `db_roles.py` | Role 5→6, Risk 8→9 |
| `orphaned_users.py` | Status 7→8 |
| `databases.py` | Recovery 6→7, State 7→8, Trustworthy 10→11 |
| `triggers.py` | Highlight cols 4-7→5-8 |
| `config.py` | Status 7→8, Risk 8→9 |
| `backups.py` | LastBackup 6→7, Status 10→11 |
| `client_protocols.py` | Enabled 5→6, Status 7→8 |
| `audit_settings.py` | Status 7→8 |
| `permissions.py` | State 8→9, Risk 11→12 |

## Tests
All 178 tests pass after fixes.

---

## Commit Message
```
fix(excel+sync): comprehensive column fixes + exception detection for all sheets

1. Fixed 17 Excel sheet modules for UUID column offset:
   - Row colors no longer applied to Action column (stays white)
   - All cell indices corrected (+1 for UUID column A)

2. Fixed exception detection in annotation_sync.py:
   - Now uses action_needed field for sheets without Status column
   - Fixes Sensitive Roles, Services, Permissions exceptions not logging

All 178 tests pass.
```
